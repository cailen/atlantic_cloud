*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:ATLANTIC-NET-MGMT - [0:0]
:PUBLIC - [0:0]
:TRUSTED - [0:0]

# Filter all INPUT traffic through custom chains:
-A INPUT -j ATLANTIC-NET-MGMT
-A INPUT -j PUBLIC
-A INPUT -j TRUSTED

# Allow traffic from loopback interface:
-A INPUT -i lo -j ACCEPT

# Allow already established traffic
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

####################
# Custom Rule Chains
####################
# Allow traffic from Atlantic.Net Management Ranges:
-A ATLANTIC-NET-MGMT -s 209.208.0.192/26 -j ACCEPT
-A ATLANTIC-NET-MGMT -s 209.208.50.9 -j ACCEPT
-A ATLANTIC-NET-MGMT -s 209.208.50.11 -p udp -m udp --dport 161 -j ACCEPT
-A ATLANTIC-NET-MGMT -s 209.208.116.206 -j ACCEPT

{% if cdp_backups == "yes" %}
-A ATLANTIC-NET-MGMT -s cdp.dal-tx.atlantic.net -p tcp -m tcp --dport 1167 -j ACCEPT -m comment --comment "CDP Dallas"
-A ATLANTIC-NET-MGMT -s cdp.tor-on.atlantic.net -p tcp -m tcp --dport 1167 -j ACCEPT -m comment --comment "CDP Toronto"
-A ATLANTIC-NET-MGMT -s cdp.sfo-ca.atlantic.net -p tcp -m tcp --dport 1167 -j ACCEPT -m comment --comment "CDP San Francisco"
{% endif %}

{% if trendmicro == "yes" %}
-A ATLANTIC-NET-MGMT -s 209.208.116.206 -p tcp -m tcp --dport 4118:4122 -j ACCEPT -m comment --comment "TrendMicro"
{% endif %}

{% if firewall == "yes" %}
###############
# Trusted Chain
###############
-A TRUSTED -s {{ vpn_range }} -j ACCEPT
{% endif %}

### Please remove me when done provisioning ###
-A PUBLIC -s 104.245.39.134 -j ACCEPT -m comment --comment "Ansible Control Tower - Please remove me when done provisioning"

COMMIT
